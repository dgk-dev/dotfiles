#!/bin/bash
# Sync API keys from Bitwarden to ~/.claude/.env.local
# Requires: bw (Bitwarden CLI), BW_SESSION env var

set -e

if ! command -v bw &> /dev/null; then
    echo "Error: Bitwarden CLI not installed"
    echo "Run: npm install -g @bitwarden/cli"
    exit 1
fi

if [ -z "$BW_SESSION" ]; then
    echo "Error: BW_SESSION not set"
    echo "Run: export BW_SESSION=\$(bw unlock --raw)"
    exit 1
fi

echo "Syncing API keys from Bitwarden..."
bw sync > /dev/null

# Fetch keys
NOTION_API_KEY=$(bw get notes "notion-api-key" 2>/dev/null) || true
OPENROUTER_API_KEY=$(bw get notes "openrouter-api-key" 2>/dev/null) || true
MAGIC_API_KEY=$(bw get notes "magic-api-key" 2>/dev/null) || true
NEON_API_KEY=$(bw get notes "neon-api-key" 2>/dev/null) || true

# Telegram (stored as multi-line)
TELEGRAM_DATA=$(bw get notes "telegram-bot" 2>/dev/null) || true
TELEGRAM_BOT_TOKEN=$(echo "$TELEGRAM_DATA" | grep "BOT_TOKEN=" | cut -d= -f2)
TELEGRAM_CHAT_ID=$(echo "$TELEGRAM_DATA" | grep "CHAT_ID=" | cut -d= -f2)

# Generate .env.local
ENV_FILE="$HOME/.claude/.env.local"
mkdir -p "$(dirname "$ENV_FILE")"

cat > "$ENV_FILE" << EOF
# Claude Code MCP 환경변수
# Auto-generated by sync-claude-env.sh from Bitwarden
# $(date)

# Notion API
NOTION_API_KEY=${NOTION_API_KEY}

# OpenRouter API
OPENROUTER_API_KEY=${OPENROUTER_API_KEY}

# 21st.dev Magic API
MAGIC_API_KEY=${MAGIC_API_KEY}

# Telegram Bot (ClaudeCodeNotify)
TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

# Neon Postgres API
NEON_API_KEY=${NEON_API_KEY}
EOF

echo "✓ Created $ENV_FILE"
echo ""
echo "Keys synced:"
[ -n "$NOTION_API_KEY" ] && echo "  ✓ NOTION_API_KEY"
[ -n "$OPENROUTER_API_KEY" ] && echo "  ✓ OPENROUTER_API_KEY"
[ -n "$MAGIC_API_KEY" ] && echo "  ✓ MAGIC_API_KEY"
[ -n "$TELEGRAM_BOT_TOKEN" ] && echo "  ✓ TELEGRAM_BOT_TOKEN"
[ -n "$TELEGRAM_CHAT_ID" ] && echo "  ✓ TELEGRAM_CHAT_ID"
[ -n "$NEON_API_KEY" ] && echo "  ✓ NEON_API_KEY"
