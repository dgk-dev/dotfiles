#!/bin/bash
# Dotfiles ì–‘ë°©í–¥ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸
# Remote ë¨¼ì € pull â†’ ë¡œì»¬ ë³€ê²½ push

CONFIG="/usr/bin/git --git-dir=$HOME/.cfg/ --work-tree=$HOME"
LOCK_FILE="/tmp/dotfiles-sync.lock"
LAST_SYNC="$HOME/.local/log/dotfiles-last-sync"

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
mkdir -p "$HOME/.local/log"

# ìµœê·¼ 5ë¶„ ì´ë‚´ ë™ê¸°í™”í–ˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
if [ -f "$LAST_SYNC" ]; then
    LAST_TIME=$(cat "$LAST_SYNC" 2>/dev/null)
    LAST_EPOCH=$(date -d "$LAST_TIME" +%s 2>/dev/null || echo 0)
    NOW_EPOCH=$(date +%s)
    DIFF=$((NOW_EPOCH - LAST_EPOCH))
    if [ $DIFF -lt 300 ]; then
        exit 0
    fi
fi

# ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
if [ -f "$LOCK_FILE" ]; then
    exit 0
fi
touch "$LOCK_FILE"
trap "rm -f $LOCK_FILE" EXIT

# 1. Remoteì—ì„œ ë¨¼ì € pull (remoteê°€ í•­ìƒ ìš°ì„ )
$CONFIG pull --rebase origin main 2>/dev/null || true

# 2. ë¡œì»¬ ë³€ê²½ ì‚¬í•­ í™•ì¸
if ! $CONFIG diff --quiet HEAD 2>/dev/null; then
    # ì¶”ì  ì¤‘ì¸ íŒŒì¼ë§Œ ìžë™ ì»¤ë°‹
    $CONFIG add -u
    $CONFIG commit -m "auto-sync: $(hostname) $(date '+%Y-%m-%d %H:%M')" 2>/dev/null || true
    $CONFIG push origin main 2>/dev/null
    echo "âœ… Dotfiles synced"
else
    echo "âœ… Dotfiles up to date"
fi

# 3. WezTerm ì„¤ì • ë™ê¸°í™” (Linux â†’ Windows)
# WSL í™˜ê²½ì—ì„œ WezTermì€ Windows ì•±ì´ë¯€ë¡œ Windows ê²½ë¡œì— ì„¤ì • í•„ìš”
if [ -f "$HOME/.wezterm.lua" ]; then
    # Windows ì‚¬ìš©ìž í´ë” ìžë™ ê°ì§€
    WIN_USER=$(cmd.exe /c "echo %USERNAME%" 2>/dev/null | tr -d '\r\n')
    WIN_WEZTERM="/mnt/c/Users/$WIN_USER/.wezterm.lua"

    if [ -n "$WIN_USER" ] && [ -d "/mnt/c/Users/$WIN_USER" ]; then
        # íŒŒì¼ì´ ë‹¤ë¥¼ ë•Œë§Œ ë³µì‚¬ (ë¶ˆí•„ìš”í•œ ì“°ê¸° ë°©ì§€)
        if ! cmp -s "$HOME/.wezterm.lua" "$WIN_WEZTERM" 2>/dev/null; then
            cp "$HOME/.wezterm.lua" "$WIN_WEZTERM"
            echo "ðŸ–¥ï¸ WezTerm config synced to Windows"
        fi
    fi
fi

# 5. Password store ë™ê¸°í™” + .env.local ìž¬ìƒì„±
if [ -d "$HOME/.password-store" ] && command -v pass &>/dev/null; then
    # Pull ë¨¼ì €
    git -C "$HOME/.password-store" pull --rebase origin main 2>/dev/null || true

    # ë¡œì»¬ ë³€ê²½ì‚¬í•­ push (ìƒˆë¡œ ì¶”ê°€ëœ í‚¤ ë™ê¸°í™”)
    if ! git -C "$HOME/.password-store" diff --quiet HEAD 2>/dev/null || \
       [ "$(git -C "$HOME/.password-store" rev-list --count @{u}..HEAD 2>/dev/null)" -gt 0 ]; then
        git -C "$HOME/.password-store" push origin main 2>/dev/null || true
    fi

    # .env.local ìž¬ìƒì„± (ê°œë³„ í‚¤ íŒŒì¼ì—ì„œ)
    STORE_DIR="$HOME/.password-store"
    if [ -d "$STORE_DIR/claude" ]; then
        mkdir -p "$HOME/.claude"
        cat > "$HOME/.claude/.env.local" << 'HEADER'
# Claude Code MCP í™˜ê²½ë³€ìˆ˜
# Auto-generated by dotfiles-sync.sh
HEADER
        for gpg_file in "$STORE_DIR/claude/"*.gpg; do
            [ -f "$gpg_file" ] || continue
            key=$(basename "$gpg_file" .gpg)
            value=$(pass show "claude/$key" 2>/dev/null || echo "")
            [ -n "$value" ] && echo "export $key='$value'" >> "$HOME/.claude/.env.local"
        done
    fi
fi

# 6. MCP ì„œë²„ ë™ê¸°í™” (mcp-servers.json ë³€ê²½ ì‹œ)
MCP_CONFIG="$HOME/.claude/mcp-servers.json"
MCP_HASH_FILE="$HOME/.local/log/mcp-servers-hash"

if [ -f "$MCP_CONFIG" ] && command -v claude &>/dev/null; then
    CURRENT_HASH=$(md5sum "$MCP_CONFIG" 2>/dev/null | awk '{print $1}')
    LAST_HASH=$(cat "$MCP_HASH_FILE" 2>/dev/null || echo "")

    if [ "$CURRENT_HASH" != "$LAST_HASH" ]; then
        echo "ðŸ”„ MCP config changed, updating servers..."
        bash "$HOME/.local/bin/setup-claude-mcp.sh" 2>/dev/null || true
        echo "$CURRENT_HASH" > "$MCP_HASH_FILE"
    fi
fi

# 7. í•„ìˆ˜ íŒ¨í‚¤ì§€ ìžë™ ì„¤ì¹˜
install_if_missing() {
    local cmd="$1"
    local install_cmd="$2"
    if ! command -v "$cmd" &>/dev/null; then
        echo "ðŸ“¦ Installing $cmd..."
        eval "$install_cmd"
    fi
}

# apt íŒ¨í‚¤ì§€ (fzf ë“±)
APT_PACKAGES=""
command -v fzf &>/dev/null || APT_PACKAGES="$APT_PACKAGES fzf"
command -v eza &>/dev/null || APT_PACKAGES="$APT_PACKAGES eza"
command -v batcat &>/dev/null || APT_PACKAGES="$APT_PACKAGES bat"
command -v fdfind &>/dev/null || APT_PACKAGES="$APT_PACKAGES fd-find"
command -v keychain &>/dev/null || APT_PACKAGES="$APT_PACKAGES keychain"

if [ -n "$APT_PACKAGES" ]; then
    echo "ðŸ“¦ Installing apt packages:$APT_PACKAGES"
    sudo apt update -qq && sudo apt install -y -qq $APT_PACKAGES
fi

# Starship (curl ì„¤ì¹˜)
if ! command -v starship &>/dev/null; then
    echo "ðŸ“¦ Installing starship..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y >/dev/null 2>&1
fi

# zoxide (curl ì„¤ì¹˜)
if ! command -v zoxide &>/dev/null; then
    echo "ðŸ“¦ Installing zoxide..."
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash >/dev/null 2>&1
fi

# lazygit (GitHub release)
if ! command -v lazygit &>/dev/null; then
    echo "ðŸ“¦ Installing lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*' 2>/dev/null)
    if [ -n "$LAZYGIT_VERSION" ]; then
        curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" 2>/dev/null
        tar xf /tmp/lazygit.tar.gz -C /tmp lazygit 2>/dev/null
        sudo install /tmp/lazygit /usr/local/bin 2>/dev/null
        rm -f /tmp/lazygit /tmp/lazygit.tar.gz
    fi
fi

# ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°„ ê¸°ë¡
date > "$LAST_SYNC"
