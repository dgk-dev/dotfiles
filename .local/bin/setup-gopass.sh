#!/bin/bash
# ============================================
# gopass 자동 설정 스크립트
# GPG 키 가져오기 + API 키 복원
# ============================================

set -e

echo "Setting up gopass..."

# 1. Clone gopass store (or re-clone if wrong repo)
CORRECT_REPO="git@github.com:dgk-dev/gopass-store.git"
if [ -d "$HOME/.password-store" ]; then
    CURRENT_REPO=$(git -C "$HOME/.password-store" remote get-url origin 2>/dev/null || echo "")
    if [ "$CURRENT_REPO" != "$CORRECT_REPO" ]; then
        echo "  Wrong repo detected, re-cloning..."
        rm -rf "$HOME/.password-store"
    fi
fi

if [ ! -d "$HOME/.password-store" ]; then
    echo "  Cloning password store..."
    git clone "$CORRECT_REPO" "$HOME/.password-store"
fi

# 2. Import GPG key if not exists
if ! gpg --list-secret-keys | grep -q "DGK"; then
    echo "  Importing GPG key..."
    gpg --batch --import "$HOME/.password-store/.gpg-backup/public-key.asc"
    
    # Setup gpg-agent for loopback pinentry
    mkdir -p ~/.gnupg
    chmod 700 ~/.gnupg
    grep -q "allow-loopback-pinentry" ~/.gnupg/gpg-agent.conf 2>/dev/null || \
        echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
    gpg-connect-agent reloadagent /bye 2>/dev/null || true
    
    # Private key needs passphrase
    echo ""
    echo "  ⚠️  GPG 비밀번호를 입력하세요 (마스터 비밀번호)"
    export GPG_TTY=$(tty)
    gpg --pinentry-mode loopback --import "$HOME/.password-store/.gpg-backup/private-key.asc"
    
    # Trust the key
    KEY_ID=$(gpg --list-keys --keyid-format=short | grep -B1 "DGK" | head -1 | awk '{print $1}')
    echo -e "5\ny\n" | gpg --command-fd 0 --expert --edit-key "$KEY_ID" trust quit 2>/dev/null || true
fi

# 3. Generate .env.local from gopass
echo "  Generating .env.local..."
mkdir -p "$HOME/.claude"
cat > "$HOME/.claude/.env.local" << 'HEADER'
# Claude Code MCP 환경변수
# 이 파일은 git에 커밋하지 마세요!
# Auto-generated by setup-gopass.sh

HEADER

# Add each secret from gopass
for secret in $(gopass ls -f claude/ 2>/dev/null); do
    key=$(basename "$secret")
    value=$(gopass show -o "$secret" 2>/dev/null || echo "")
    if [ -n "$value" ]; then
        echo "$key=$value" >> "$HOME/.claude/.env.local"
    fi
done

echo "✅ gopass setup complete!"
echo "   API keys saved to ~/.claude/.env.local"
